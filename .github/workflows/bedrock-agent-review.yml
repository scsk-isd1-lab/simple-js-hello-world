name: Bedrock Agent Review

on:
  issue_comment:
    types: [created]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

env:
  AWS_REGION: "ap-northeast-1"

jobs:
  dispatch-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.issue.pull_request != null }}
    steps:
      - name: Dispatch Bedrock runner workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.issue.number;
            const ref = 'main';
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'bedrock-agent-review-runner.yml',
              ref,
              inputs: { pr_number: String(prNumber) }
            });
            core.info(`Dispatched runner for PR #${prNumber} on ${ref}`);
      - name: Comment run dispatch notice
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const body = 'Bedrock分析ランを起動しました。Actionsタブの "Bedrock Agent Review (runner)" をご確認ください。';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });
